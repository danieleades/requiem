---
_version: '1'
uuid: 8c8ad7a7-82a8-4235-897a-bb5d5c7cd893
created: 2025-11-20T12:20:14.412106535Z
parents:
- uuid: d5520b93-355c-4a0e-be2b-3820976d21a4
<<<<<<<< HEAD:docs/src/requirements/SPC/006.md
  fingerprint: 3890e8ca051d0f9d2e9fa6497d7ab658331e6f2a9c9b36f2e85a8be5a7003334
  hrid: SYS-028
========
  fingerprint: 270fe9ca63766035b9f7ac0d33afca5c9f21e71e7178bf8b1cf6a048c915af07
  hrid: CLI-SYS-028
>>>>>>>> 1133129 (implement MCP server):docs/src/requirements/CLI/SPC/006.md
---
# CLI-SPC-006 Validate Command Specification

## Purpose

Provide a unified validation experience that comprehensively checks repository health across multiple dimensions (structure, paths, links, fingerprints) with clear reporting, actionable guidance, and optional auto-repair capabilities.

## Experience Principles

- **Comprehensive by default:** Run all checks unless user specifies a subset
- **Clear categorization:** Group issues by type (structure, paths, links, suspect) for easy diagnosis
- **Actionable guidance:** Every error includes a suggestion for how to fix it
- **Safe auto-fix:** Only repair issues that are unambiguous and reversible
- **CI-friendly:** Exit codes and quiet mode support automation workflows
- **Progressive detail:** Summary by default, full details on request

## Command Behaviours

### `req validate` (default: all checks)

- Runs all validation checks: structure, paths, links, suspect
- Default output is a summary table grouped by check type
- Exit codes:
  - `0`: No issues found (repository is healthy)
  - `2`: Issues found (without --fix)
  - `1`: Error (unable to load repository, invalid arguments)

**Default output format:**
```
Validating repository...

✓ Structure:  120 requirements, all valid
✗ Paths:      3 files not at canonical locations
✗ Links:      1 circular dependency detected
✗ Suspect:    15 suspect links found

Summary: 19 issues found across 3 categories
```

### `req validate --check <TYPE>`

- Run specific check type(s): `paths`, `links`, `suspect`, `structure`, `all`
- Multiple `--check` flags can be combined: `req validate --check paths --check links`
- Output shows only requested check types

**Check types:**

1. **Structure check:**
   - Valid YAML frontmatter in all files
   - Required fields present (uuid, _version, created)
   - HRID format valid in first heading
   - No duplicate UUIDs
   - No duplicate HRIDs

2. **Paths check:**
   - Files at canonical locations per path mode configuration
   - Filename matches HRID
   - Directory structure correct for path mode

3. **Links check:**
   - No broken parent references (all parent UUIDs exist)
   - No circular dependencies (graph is DAG)
   - Parent HRIDs match current parent HRIDs

4. **Suspect check:**
   - Parent fingerprints match current parent content
   - Missing parents reported

### `req validate --fix`

- Attempt automatic repair of fixable issues
- Only fixes unambiguous, safe issues:
  - **Paths:** Move files to canonical locations
  - **Links:** Update stale parent HRIDs (not fingerprints)
- Does NOT auto-fix:
  - Duplicate HRIDs (requires manual resolution)
  - Circular dependencies (requires manual restructuring)
  - Suspect links (requires manual review via `req review`)
  - Invalid frontmatter (requires manual correction)
- Shows what was fixed and what still requires manual intervention
- Prompts for confirmation before making changes (unless `--yes`)

**Example:**
```
Validating repository...

✗ Paths: 3 files not at canonical locations
  
Attempting auto-fix...
  
  ✓ Moved USR-001.md → requirements/USR-001.md
  ✓ Moved SYS-002.md → requirements/SYS-002.md
  ✓ Moved TST-001.md → requirements/TST-001.md

✗ Suspect: 15 suspect links found (requires manual review)
  Run 'req review' to accept changes

Summary: 3 issues fixed, 15 require manual review
```

### `req validate --output <FORMAT>`

- **table** (default): Human-readable grouped summary
- **json**: Structured JSON with all issue details
- **summary**: One-line summary for scripting

**JSON structure:**
```json
{
  "status": "issues_found",
  "total_requirements": 120,
  "issues": {
    "structure": [],
    "paths": [
      {
        "hrid": "USR-001",
        "current_path": "old/USR-001.md",
        "expected_path": "requirements/USR-001.md",
        "fixable": true
      }
    ],
    "links": [
      {
        "type": "circular_dependency",
        "cycle": ["USR-001", "SYS-002", "TST-003", "USR-001"],
        "fixable": false
      }
    ],
    "suspect": [
      {
        "child": "SYS-001",
        "parent": "USR-001",
        "stored_fingerprint": "abc123...",
        "current_fingerprint": "def456...",
        "fixable": false
      }
    ]
  },
  "summary": {
    "total_issues": 19,
    "fixable_issues": 3,
    "manual_issues": 16
  }
}
```

### `req validate --quiet`

- Suppress all output except errors
- Exit code still indicates status (0 = ok, 2 = issues)
- Useful for CI pipelines that only care about pass/fail

### `req validate --dry-run`

- When combined with `--fix`, shows what would be fixed without making changes
- Useful for previewing auto-fix behavior

## Accessibility & Ergonomics

- Respect `NO_COLOR` environment variable
- Use clear symbols: ✓ (success), ✗ (failure), → (suggestion)
- Group related issues together for scanability
- Limit line width to ≤ 80 characters
- Provide clear next steps for each issue type

## Empty-State & Error Messaging

**All checks pass:**
```
Validating repository...

✓ Structure:  120 requirements, all valid
✓ Paths:      All files at canonical locations
✓ Links:      No broken references, graph is DAG
✓ Suspect:    No suspect links

Repository is healthy (0 issues)
```

**Unable to load repository:**
```
Error: Unable to load repository
  Failed to read .req/config.toml: No such file or directory
  
  Run 'req init' to initialize a repository
```

**Invalid check type:**
```
Error: Unknown check type 'typo'
  Valid types: structure, paths, links, suspect, all
```

## Integration with Other Commands

- `req validate --check suspect` is equivalent to `req review` (list mode)
- `req validate --check paths` replaces `req diagnose paths`
- `req validate --fix --what paths` is equivalent to `req sync --what paths`
- Status dashboard (`req status`) could show validation summary

## Detailed Issue Reporting

When issues are found, provide actionable guidance:

**Structure issues:**
```
[Structure Issues]

USR-001.md
  ✗ Missing required field: uuid
  → Add a UUID v4 to frontmatter
  
SYS-002.md
  ✗ Invalid HRID format in heading: 'SYS-2'
  → Expected format: SYS-002 (zero-padded to 3 digits)
  → Update first heading to: # SYS-002 Title
```

**Path issues:**
```
[Path Issues]

old/USR-001.md
  Expected: requirements/USR-001.md
  → Run 'req validate --fix' to move automatically
  → Or: req sync --what paths
  
docs/SYS-002.md
  Expected: requirements/SYS-002.md
  → Run 'req validate --fix' to move automatically
```

**Link issues:**
```
[Link Issues]

Circular dependency detected:
  USR-001 → SYS-002 → TST-003 → USR-001
  → Break the cycle by removing one of these parent links manually
  
Broken reference:
  TST-005 references parent USR-999 (UUID: abc123...)
  → Parent requirement does not exist
  → Check if parent was deleted or UUID is incorrect
```

**Suspect links:**
```
[Suspect Links]

15 suspect links found (parent content changed)

  SYS-001 → USR-001  (changed 2d ago)
  SYS-002 → USR-001  (changed 2d ago)
  TST-001 → SYS-003  (changed 5h ago)
  ... (12 more)
  
→ Run 'req review' to see details and accept changes
→ Or: req review --accept --all to accept all
```
